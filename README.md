# Правила построения карт переназначения таблиц и данных для ИНФО-ОЙЛ (только для linux версии)

При конвертации входящий файлов таблицы AZS, SMENA, ORGS, COMPANIES, OWNERS, AZSOWN — формируются автоматически.

## Формат файла описания таблиц БД :
```xml
<?xml version="1.0" encoding="UTF-8"?>
<table id="ИМЯ_ТАБЛИЦЫ">
  <field name="ИМЯ_ПОЛЯ" typ="ТИП_ДАННЫХ" [pk="true"] [len="n"] [prec="n"]/>
  <field name="..."/>
  ...	 
</table>
```

Типы данных:

|Тип|Описание|
|:--|:-------|
|date|Дата в формате DD/MM/YYYY|
|time|Время в формате HH:MM:SS|
|datetime|Дата в формате DD/MM/YYYY HH:MM:SS|
|timestamp|Дата в формате DD/MM/YYYY HH:MM:SS|
|char|строковое значение|
|Number|числовое значения|

Для типов char и number можно указывать атрибут len=«N» где N — длина форматируемого строкового значения

Для типа number можно указывать атрибут prec=«N» где N — количество десятичных знаков

При указании len значения для типа char выравниваются по левому краю, а для number по правому

Атрибут pk=true — указывает, что поле включено в набор ключевых значений (пока не используется)

## Описание формата файла переназначения таблиц
```xml
<?xml version="1.0" encoding="UTF-8"?>
<tablemap>

  <match target="ИМЯ_ВХОДНОГО_ПОТОКА">
    <alias>ИМЯ_ТАБЛИЦЫ</alias>
    ...
    <alias>ИМЯ_ТАБЛИЦЫ_N</alias>
  </match>
  < match ...>	
	  ...
  </match>
</tablemap>
```

## Описание формата  файла переназначения полей.

Карта переназначения полей хранится в файлах БД mmdb по пути /info-oil/maps/tables/ИМЯ_ТАБЛИЦЫ

Формат описания следующий:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<fieldmap>

  <match target="ИМЯ_ПОЛЯ_ВХОДНОГО_ПОТОКА">
    <alias>ИМЯ_ПОЛЯ_ТАБЛИЦЫ</alias>
 	  ... 
    <alias>ИМЯ_ПОЛЯN_ТАБЛИЦЫ</alias>
  </match>

  <match ...>	
	   ...
  </match>
</fieldmap>
```

Для <alias> можно использовать атрибуты set=«ЗНАЧЕНИЕ» - установить значения для поля и test=«ЗНАЧЕНИЕ» - обработать если входное значение соответствует указанному. (фильтр значений)

В качестве значений test и set можно использовать значение NULL 

в качестве  ИМЯ_ПОЛЯ_ВХОДНОГО_ПОТОКА можно использовать следующие значения:
```
__ROWNUMBER__	- порядковый номер записи входного файла
__SMENA_AZSKEY__ - идентификатор текущей АЗС
__SMENA_BEGDATE__ -  дата открытия обрабатываемой смены
__SMENA_ENDDATE__ -  дата закрытия обрабатываемой смены	
__SMENA_NUMBER__ -  номер обрабатываемой смены
__SMENA_DAYNUMBER__ -  номер в течении суток обрабатываемой смены
__SYSTEM_DATE__ - системная дата (дата начала процесса конвертации)
__EVENT_GROUP__ - Группа событий
__EVENT_CODE__ - Код событий
__OWN__ - Код владельца
__COM__ - Код управляющей компании						
__ORG__ - Код Эксплуатирующей организации
__AZSOWNER__ - код владельца АЗС
__AZSNUM__ - номер АЗС
__AZSSPOOL__ - идентификатор модемного спула АЗС
__REGION__ - код региона
```

Для этих значений атрибут test — не указывается. Эти значения считываются в начале обработки

Результирующее значение Выходного поля будет определяться путем считывания значений <alias> сверху вниз. 

## Пример переопределения поля 

Входной файл имеет поля п1 и п2 

Таблица представлена ниже

|п1|п2|
|:-|:-|
|1|11|
|1|22|
|1|33|
|null|44|

Карта преобразования выглядит следующим образом
```xml
<match target= «__ROWNUMBER__»>
	<alias>f2</alias>
</match>
<match target= «п1»>
	<alias set= «2»>f1</alias>
	<alias set= «3» test= «NULL»>f1<alias>
	<alias test=«NULL» set = «40»>f2</alias>
</match>
```

Результирующая таблица будет иметь вид:

|f1|f2|
|:-|:-|
|2|1|
|2|2|
|2|3|
|3|40|
